<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width initial-scale=1">
    <title>CodingPrime</title>
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/highlight.js.solarized.css">
    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
  </head>
  <body>
    <nav role="navigation" class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar" class="navbar-toggle collapsed"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand">CodingPrime</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="/">Home</a></li>
            <li><a href="#about">About</a></li>
            <li><a href="#contact">Contact</a></li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container">
      <article class="post">
        <header>
          <h2 class="post-title"><a href="/blog/modelmewhy">ModelMe...why?</a></h2>
          <time datetime="2013-08-31 11:46" class="timestamp">August 31, 2013</time>
        </header><p>My day job consists of architecting and maintaining several Rails
applications.  Some of these must deal with custom data sources that
were architected before there were standards for inter-application
communication (SOAP, REST, XML-RPC, etc).  One in particular is is a custom TCP
server that responds to method calls (using XML as the transport mechanism).
Replacing the service is not an option (as is usually the case with any
<a href="http://fc05.deviantart.net/fs71/f/2012/013/0/7/pain_in_the_ass_by_sk8rnerd-d4m9ag5.jpg">PITA</a>
legacy problem), so I have to communicate with it.</p>
<h3 id="activerecord-arel">ActiveRecord/AREL</h3>
<p>For all of its perceived shortcomings,
<a href="https://github.com/rails/rails/tree/master/activerecord">ActiveRecord</a> is an
excellent piece of software.  More importantly, <a href="https://github.com/rails/arel">arel</a>,
the relational library that drives it is a very well architected masterpiece.
Together, they do a lot of magic that makes interacting with SQL data sources
fairly effortless.</p>
<p>While arel allows for adding custom <em>visitors</em> (which allow you to customize
the &quot;SQL&quot; generated to perform queries/updates), both libraries are tightly
coupled to the RDBMS data store.</p>
<h3 id="datamapper">DataMapper</h3>
<p>Another wonderful little gem is <a href="http://datamapper.org/">DataMapper</a>.  This
thing solves the problems above by taking a different approach to modeling
data.  Instead of inferring structure from the database (as ActiveRecord
does), it puts this responsibility back in the hands of the user.  It also
delegates the job of interacting with the data store to custom &quot;adapters&quot;,
which understand how to communicate with whatever <em>thingie</em> has the
data you want.  If you have to work in a mixed environment and can get away
with it, DataMapper is definitely the way to go.</p>
<h3 id="stuck-">Stuck?</h3>
<p>Unfortunately, I find myself stuck dealing with code that uses ActiveRecord
to deal with the local application data, but still needs to be able to access
data stored in the custom service described above.  I could use DataMapper for
just those areas of the app, but this just feels...dirty.  As a developer, I
have enough to think about.  I&#39;d rather not have to try and remember which DSL
is used for which models.  One application, one syntax for dealing with data.
And it should just work.</p>
<h3 id="modelme">ModelMe</h3>
<p>After several attempts to bridge the gap, and digging around the source of
several projects on Github (notably <a href="https://github.com/maccman/supermodel">supermodel</a>),
I decided to just write some fucking code.  The result is <em><a href="https://github.com/t3hpr1m3/model_me">ModelMe</a></em>.
It&#39;s basically everything from ActiveModel I could squeeze in, with a lot of
the relationship/query/association logic inspired by (read: stolen from)
ActiveRecord.  It follows the same methodology as DataMapper (explicit
attribute definition/delegation of datastore interaction) but looks, smells,
and tastes like ActiveRecord.  It&#39;s fairly stable, and is currently being used
in several mission critical applications dealing with financial data (yes, my
sphincter puckers from time to time).</p>
<p>Is it perfect?  Hell no.  But it&#39;s good enough to get through the day.</p>

      </article>
      <article class="post">
        <header>
          <h2 class="post-title"><a href="/blog/skipping-asset-precompile">Skipping asset precompile</a></h2>
          <time datetime="2012-07-12 17:20" class="timestamp">July 12, 2012</time>
        </header><p>Waiting on asset precompilation is a PITA, especially if no assets have been
changed.  Thankfully,
<a href="http://www.bencurtis.com/2011/12/skipping-asset-compilation-with-capistrano/">Ben Curtis</a>
came up with a workable solution.  Except...</p>
<p>Ben&#39;s method fails on the initial deployment, because <em>current_revision</em> tries to
read <em>/path/to/app/current/REVISION</em>, which won&#39;t exist yet.  After trying several
approaches, I have arrived at one which works for me.  There are probably other,
more elegant approaches, but this one seems clear enough for my purposes. 
Posting it here for posterity.</p>
<pre><code class="hljs ruby">namespace <span class="hljs-symbol">:deploy</span> <span class="hljs-keyword">do</span>
  namespace <span class="hljs-symbol">:assets</span> <span class="hljs-keyword">do</span>
    task <span class="hljs-symbol">:precompile</span>, <span class="hljs-symbol">roles:</span> <span class="hljs-symbol">:web</span>, <span class="hljs-symbol">except:</span> {<span class="hljs-symbol">no_release:</span> <span class="hljs-keyword">true</span>} <span class="hljs-keyword">do</span>
      from = source.next_revision(current_revision) <span class="hljs-keyword">if</span> capture(<span class="hljs-string">"[ -f <span class="hljs-subst">#{<span class="hljs-constant">File</span>.join(current_path, <span class="hljs-string">'REVISION'</span>)}</span> ] || echo '1'"</span>).empty?
      <span class="hljs-keyword">if</span> from.<span class="hljs-keyword">nil</span>? || capture(<span class="hljs-string">"cd <span class="hljs-subst">#{latest_release}</span> &amp;&amp; <span class="hljs-subst">#{source.local.log(from)}</span> vendor/assets app/assets lib/assets | wc -l"</span>).to_i &gt; <span class="hljs-number">0</span>
        run <span class="hljs-string">%Q{cd <span class="hljs-subst">#{latest_release}</span> &amp;&amp; <span class="hljs-subst">#{rake}</span> RAILS_ENV=<span class="hljs-subst">#{rails_env}</span> <span class="hljs-subst">#{asset_env}</span> assets:precompile}</span>
      <span class="hljs-keyword">else</span>
        logger.info <span class="hljs-string">"Skipping asset pre-compilation because there were no asset changes."</span>
      <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></code></pre>
      </article>
      <article class="post">
        <header>
          <h2 class="post-title"><a href="/blog/rspec-autotest-rails3-and-engines">RSpec, Autotest, Rails3, and Engines</a></h2>
          <time datetime="2010-12-06 18:19" class="timestamp">December 6, 2010</time>
        </header><p>I&#39;ve got an app I&#39;m building that is comprised of several engines running in
<em>vendor/nsweb</em>.  I want each engine to have its own specs, without cluttering
up the main app&#39;s <em>spec</em> folder.  I also want to be able to run tests for ALL
engines at once, both using rake and through autotest.  To accomplish the first
task, I added the following:</p>
<pre><code class="hljs ruby"><span class="hljs-comment"># lib/tasks/rspec.rake</span>
<span class="hljs-constant">RSpec::Core::RakeTask</span>.module_eval <span class="hljs-keyword">do</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>pattern
    extras = []
    <span class="hljs-constant">Dir</span>[<span class="hljs-constant">File</span>.join( <span class="hljs-constant">File</span>.expand_path( <span class="hljs-string">'vendor'</span> ), <span class="hljs-string">'nsweb'</span>, <span class="hljs-string">'*'</span> )].flatten.each <span class="hljs-keyword">do</span> |dir|
      <span class="hljs-keyword">if</span> <span class="hljs-constant">File</span>.directory?( dir )
        extras += <span class="hljs-constant">File</span>.join( dir, <span class="hljs-string">'spec'</span>, <span class="hljs-string">'**'</span>, <span class="hljs-string">'*_spec.rb'</span> ).to_s
      <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
    [<span class="hljs-variable">@pattern</span>] | extras
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></code></pre>

<p>Now, if I run</p>
<pre><code><span class="hljs-preprocessor"># rake spec</span></code></pre>

<p>the specs from my engines will be run as well.</p>
<p>For autotest, I added this:</p>
<pre><code class="hljs ruby"><span class="hljs-comment"># .autotest</span>

<span class="hljs-constant">Autotest</span>.add_hook <span class="hljs-symbol">:initialize</span> <span class="hljs-keyword">do</span> |autotest|
  autotest.add_mapping( %r%^vendor/nsweb/(.*)/app/controllers/(.*)\.rb<span class="hljs-variable">$%</span> ) <span class="hljs-keyword">do</span> |<span class="hljs-number">_</span>, m|
    [<span class="hljs-string">"vendor/nsweb/<span class="hljs-subst">#{m[<span class="hljs-number">1</span>]}</span>/spec/controllers/<span class="hljs-subst">#{m[<span class="hljs-number">2</span>]}</span>_spec.rb"</span>]
  <span class="hljs-keyword">end</span>

  autotest.add_mapping( %r%^vendor/nsweb/(.*)/app/models/(.*)\.rb<span class="hljs-variable">$%</span> ) <span class="hljs-keyword">do</span> |<span class="hljs-number">_</span>, m|
    [<span class="hljs-string">"vendor/nsweb/<span class="hljs-subst">#{m[<span class="hljs-number">1</span>]}</span>/spec/models/<span class="hljs-subst">#{m[<span class="hljs-number">2</span>]}</span>_spec.rb"</span>]
  <span class="hljs-keyword">end</span>

  autotest.add_mapping( %r%^vendor/nsweb/(.*)/lib/(.*)\.rb<span class="hljs-variable">$%</span> ) <span class="hljs-keyword">do</span> |<span class="hljs-number">_</span>, m|
    [<span class="hljs-string">"vendor/nsweb/<span class="hljs-subst">#{m[<span class="hljs-number">1</span>]}</span>/spec/lib/<span class="hljs-subst">#{m[<span class="hljs-number">2</span>]}</span>_spec.rb"</span>]
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></code></pre>

<p>There is probably a much more elegant way to do both of these things, but this
worked for me.</p>

      </article>
      <article class="post">
        <header>
          <h2 class="post-title"><a href="/blog/form-cancel-button-without-javascript">Form cancel button (without Javascript)</a></h2>
          <time datetime="2010-09-02 08:38" class="timestamp">September 2, 2010</time>
        </header><p>Found <a href="http://rubypond.com/blog/capturing-a-form-cancel">this</a> today, and
banged my head on the desk for never thinking of this when trying to add a
cancel button to a form, regardless of the language.</p>

      </article>
      <article class="post">
        <header>
          <h2 class="post-title"><a href="/blog/custom-requireauthenticationfor-rspec-matcher">Custom RSpec matcher:  require_authentication_for</a></h2>
          <time datetime="2010-08-22 19:00" class="timestamp">August 22, 2010</time>
        </header><p>Like everyone, I have a bunch of controller actions that need to be protected
from unauthorized users.  I&#39;ve got RSpec tests around these methods that look
like this:</p>
<pre><code class="hljs ruby">describe <span class="hljs-constant">UsersController</span>, <span class="hljs-string">'as guest'</span> <span class="hljs-keyword">do</span>
  before( <span class="hljs-symbol">:each</span> ) <span class="hljs-keyword">do</span>
    controller.stubs( <span class="hljs-symbol">:current_user</span> ).returns( <span class="hljs-keyword">nil</span> )
  <span class="hljs-keyword">end</span>

  describe <span class="hljs-string">'index'</span> <span class="hljs-keyword">do</span>
    it <span class="hljs-string">'should prevent access'</span> <span class="hljs-keyword">do</span>
      lambda { get <span class="hljs-symbol">:index</span> }.should
        raise_error( <span class="hljs-constant">Exceptions::PermissionDenied</span> )
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>

  describe <span class="hljs-string">'edit'</span> <span class="hljs-keyword">do</span>
    it <span class="hljs-string">'should prevent access'</span> <span class="hljs-keyword">do</span>
      lambda { get <span class="hljs-symbol">:edit</span>, <span class="hljs-symbol">:id</span> =&gt; <span class="hljs-number">1</span> }.should
        raise_error( <span class="hljs-constant">Exceptions::PermissionDenied</span> )
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>

  describe <span class="hljs-string">'create'</span> <span class="hljs-keyword">do</span>
    it <span class="hljs-string">'should prevent access'</span> <span class="hljs-keyword">do</span>
      lambda { post <span class="hljs-symbol">:create</span>, <span class="hljs-symbol">:id</span> =&gt; <span class="hljs-number">1</span> }.should
        raise_error( <span class="hljs-constant">Exceptions::PermissionDenied</span> )
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></code></pre>

<p>Does exactly what I want it to do.  If I ever screw up and remove <code>index</code> from
the <code>before_filter :authenticate</code>, I&#39;ll know it when I re-run the tests.  But
I&#39;ve got lots and lots of methods like this, and wanted a more concise way to
 specify this behavior.</p>
<p>I did some searching and found quite a few different approaches (most notably
<a href="http://railscasts.com/episodes/157-rspec-matchers-macros">this</a> from Ryan
Bates, and <a href="http://github.com/nbibler/should_require_login">this</a> plugin),
but none of them, I felt, were enough.  And so, because I&#39;m a stupid fuck who
writes too much code, I threw together this custom RSpec matcher.</p>
<pre><code class="hljs ruby"><span class="hljs-comment"># spec/support/matchers/require_authentication_for.rb</span>
<span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">CustomControllerMatchers</span></span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>require_authentication_for( action, *args )
    options = args.extract_options!
    method = args.first.is_a?( <span class="hljs-constant">Symbol</span> ) ? args.first <span class="hljs-symbol">:</span> <span class="hljs-symbol">:get</span>
    <span class="hljs-constant">RequireAuthenticationMatcher</span>.new( method, action, options, <span class="hljs-keyword">self</span> )
  <span class="hljs-keyword">end</span>

  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RequireAuthenticationMatcher</span></span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> </span>initialize( method, action, args, context )
      <span class="hljs-variable">@method</span> = method
      <span class="hljs-variable">@action</span> = action
      <span class="hljs-variable">@args</span> = args
      <span class="hljs-variable">@context</span> = context
      <span class="hljs-variable">@actual_exception</span> = <span class="hljs-keyword">nil</span>
    <span class="hljs-keyword">end</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> </span>matches?( controller )
      <span class="hljs-variable">@raised_permission_denied</span> = <span class="hljs-keyword">false</span>
      <span class="hljs-keyword">begin</span>
        <span class="hljs-variable">@context</span>.send( <span class="hljs-variable">@method</span>, <span class="hljs-variable">@action</span>, <span class="hljs-variable">@args</span> )
      <span class="hljs-keyword">rescue</span> <span class="hljs-constant">Exceptions::PermissionDenied</span> =&gt; <span class="hljs-variable">@actual_exception</span>
        <span class="hljs-variable">@raised_permission_denied</span> = <span class="hljs-keyword">true</span>
      <span class="hljs-keyword">rescue</span> <span class="hljs-constant">Exception</span> =&gt; <span class="hljs-variable">@actual_exception</span>
        foo = <span class="hljs-string">'bar'</span>
      <span class="hljs-keyword">end</span>

      <span class="hljs-variable">@raised_permission_denied</span> 
    <span class="hljs-keyword">end</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> </span>failure_message_for_should
      <span class="hljs-keyword">if</span> <span class="hljs-variable">@actual_exception</span>.<span class="hljs-keyword">nil</span>?
        <span class="hljs-string">"Expected PermissionDenied, but nothing was raised"</span>
      <span class="hljs-keyword">else</span>
        <span class="hljs-string">"Expected PermissionDenied, got <span class="hljs-subst">#{<span class="hljs-variable">@actual_exception</span>.inspect}</span>"</span>
      <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> </span>failure_message_for_should_not
      <span class="hljs-keyword">if</span> <span class="hljs-variable">@actual_exception</span>.<span class="hljs-keyword">nil</span>?
        <span class="hljs-string">'Not sure what happened'</span>
      <span class="hljs-keyword">else</span>
        <span class="hljs-string">"Expected the call to succeed, but <span class="hljs-subst">#{<span class="hljs-variable">@actual_exception</span>.message}</span> was raised"</span>
      <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> </span>description
      <span class="hljs-string">"require authentication for <span class="hljs-subst">#{<span class="hljs-variable">@action</span>}</span>"</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></code></pre>

<p>My controller specs can now look like this:</p>
<pre><code class="hljs ruby">describe <span class="hljs-constant">UsersController</span>, <span class="hljs-string">'as guest'</span> <span class="hljs-keyword">do</span>
  before( <span class="hljs-symbol">:each</span> ) <span class="hljs-keyword">do</span>
    controller.stubs( <span class="hljs-symbol">:current_user</span> ).returns( <span class="hljs-keyword">nil</span> )
  <span class="hljs-keyword">end</span>

  it { should require_authentication_for( <span class="hljs-symbol">:index</span> ) }
  it { should require_authentication_for( <span class="hljs-symbol">:edit</span>, <span class="hljs-symbol">:id</span> =&gt; <span class="hljs-number">1</span> ) }
  it { should require_authentication_for( <span class="hljs-symbol">:update</span>, <span class="hljs-symbol">:post</span>, <span class="hljs-symbol">:id</span> =&gt; <span class="hljs-number">1</span> ) }
<span class="hljs-keyword">end</span></code></pre>

<p>It accomplishes the same thing, I know, but to me this is just more readable.</p>

      </article>
      <article class="post">
        <header>
          <h2 class="post-title"><a href="/blog/site-config-configyml-for-rails">Site Config (config.yml) for Rails</a></h2>
          <time datetime="2010-08-21 23:20" class="timestamp">August 21, 2010</time>
        </header><p>Over at <a href="http://railscasts.com/">Railscasts</a>, The Honourable Ryan Bates,
Esquire<sup>1</sup> has been churning out quality screencasts FOREVER.  And
while some of them become somewhat obsolete as Rails itself changes, they&#39;re
still a better starting point than most of what&#39;s available on the web.</p>
<p>One that I happened to view recently concerned
<a href="http://railscasts.com/episodes/85-yaml-configuration-file">application configuration</a>
for your Rails app being stored in a <code>.yml</code> file.  This brings site
configuration in line with database, fixtures, etc.  As usual, Ryan gives you
exactly what you need to adapt things to your situation.  So I did.  This is
my ApplicationConfiguration class.<sup>2</sup>  It basically gives you a global
<code>::AppConfig</code> object, which allows you to reverence any of your configuration
settings from a single place.  It supports nested configuration,
and automatically selects the right environment (test, production, etc).</p>
<pre><code class="hljs ruby"><span class="hljs-comment"># config/initializers/_init_app_config.rb</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApplicationConfigurationNode</span></span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>initialize( data )
    data.each <span class="hljs-keyword">do</span> |k,v|
      <span class="hljs-keyword">self</span>.assign_value( k, v )
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>assign_value( name, val )
    <span class="hljs-keyword">if</span> val.is_a?( <span class="hljs-constant">Hash</span> )
      <span class="hljs-keyword">self</span>.instance_variable_set( <span class="hljs-string">"@<span class="hljs-subst">#{name.to_s}</span>"</span>.to_sym, <span class="hljs-constant">ApplicationConfiguration</span>.new( val ) )
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">self</span>.instance_variable_set( <span class="hljs-string">"@<span class="hljs-subst">#{name.to_s}</span>"</span>.to_sym, val )
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>method_missing( name, *args )
    <span class="hljs-keyword">if</span> name.to_s =~ <span class="hljs-regexp">/(.*)=$/</span>
      <span class="hljs-keyword">self</span>.assign_value( <span class="hljs-variable">$1</span>, args.first )
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.instance_variable_defined?( <span class="hljs-string">"@<span class="hljs-subst">#{name.to_s}</span>"</span>.to_sym )
        <span class="hljs-keyword">self</span>.instance_variable_get( <span class="hljs-string">"@<span class="hljs-subst">#{name.to_s}</span>"</span>.to_sym )
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">nil</span>
      <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApplicationConfiguration</span> <span class="hljs-inheritance">&lt; <span class="hljs-parent">Rails::OrderedOptions</span></span></span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>initialize
    config_file = <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-constant">RAILS_ROOT</span>}</span>/config/config.yml"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-constant">File</span>.exists?( config_file )
      config_hash = <span class="hljs-constant">YAML</span>.load_file( config_file )
      <span class="hljs-keyword">if</span> config_hash.has_key?( <span class="hljs-constant">RAILS_ENV</span> )
        <span class="hljs-variable">@parameters</span> = <span class="hljs-constant">ApplicationConfigurationNode</span>.new( config_hash[<span class="hljs-constant">RAILS_ENV</span>] )
      <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>method_missing( name, *args )
    <span class="hljs-variable">@parameters</span>.method_missing( name, args.first )
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-constant">::AppConfig</span> = <span class="hljs-constant">ApplicationConfiguration</span>.new</code></pre>

<p>I put this in <code>config/initializers/_init_app_config.rb</code>, so that it gets loaded
 before everything else, and I&#39;m done.  Now I&#39;m free to add whatever I want to
<code>config.yml</code> and reference it from anywhere in my app.</p>
<pre><code class="hljs ruby"><span class="hljs-comment"># config/config.yml</span>
<span class="hljs-symbol">test:</span>
  <span class="hljs-symbol">harsh:</span>
    <span class="hljs-symbol">theme:</span> <span class="hljs-string">'twilight'</span>
<span class="hljs-symbol">production:</span>
  <span class="hljs-symbol">harsh:</span>
    <span class="hljs-symbol">theme:</span> <span class="hljs-string">'spacecadet'</span></code></pre>

<pre><code class="hljs ruby"><span class="hljs-comment"># app/views/layouts/_stylesheets.html.erb</span>
<span class="hljs-comment"># ...</span>
&lt;%= stylesheet_link_tag <span class="hljs-string">'harsh/<span class="hljs-subst">#{<span class="hljs-constant">::AppConfig</span>.harsh.theme}</span>'</span> %&gt;
<span class="hljs-comment"># ...</span></code></pre>

<p><sup>1</sup>All titles bestowed only by me.  Keep your attorneys to yourself.</p>
<p><sup>2</sup>I know I saw someone doing something similar to this, but for the
 life of me I can&#39;t find it.  If it was you, I apologize for not giving credit.</p>

      </article>
      <article class="post">
        <header>
          <h2 class="post-title"><a href="/blog/dualbooting-raided-windows-non-raid-linux">Dual-booting Raided Windows/Non-Raid Linux</a></h2>
          <time datetime="2010-08-21 18:12" class="timestamp">August 21, 2010</time>
        </header><p>If you&#39;re following along at home, I got my Gentoo install
<a href="moving-from-virtualbox-to-physical-disk">extracted</a> and running on physical
disk.  Now I have a problem to solve: Dual booting with Windows.  This is
only a problem because my Windows install is on a RAID0 array using an Intel
fakeraid controller.  I found all kinds of info on dual-booting Windows/Linux
while both are installed in the raid array, but nothing to help with my
situation.  So here we go.</p>
<h3 id="attempt-1-grub-on-the-linux-drive">Attempt #1 :: GRUB on the Linux drive</h3>
<p>My first attempt was to setup GRUB on the Linux drive, and tell the BIOS to
boot off that.  I knew I should add an entry to <code>grub.conf</code> to reference the
Windows drive and call <code>chainloader+</code>, but as I was typing it out I realized
that I didn&#39;t have a way to reference it.  My Spidey Sense&#0153; was telling
me I&#39;d need an initrd with all the raid info in it, so GRUB would know how to
talk to the entire RAID drive.  That sounds like work.  Moving on.</p>
<h3 id="attempt-2-grub-loaded-from-windows-boot-ini">Attempt #2 :: GRUB loaded from Windows boot.ini</h3>
<p>Next, I tried <a href="http://www.linux.com/archive/feature/113945">this</a> trick, which
has worked for me in the past.  This basically involves saving GRUB&#39;s MBR into
a file, and loading it up from Windows&#39; boot.ini, so it shows up as a bootable
entry on startup.  So I created a grub.bin from my Linux drive, copied it over,
and added the entry to boot.ini.  After a reboot, I received the dreaded
<code>GRUB Error 21</code> (which, by the way, is the most frustrating error ever
conceived by man).  Strike 2.</p>
<h3 id="attempt-3-grub-on-windows-mbr-success-">Attempt #3 :: GRUB on Windows MBR (Success!)</h3>
<p>Once I thought about what I was trying to do, I realized the solution was to
just install GRUB in the MBR of the Windows RAID0 array.  This was a little
more involved, but much less painful than creating a hacky <code>initrd</code>.  So here
goes.</p>
<h4 id="install-dmraid-and-generate-your-device-mappings">Install dmraid and generate your device mappings</h4>
<p>You&#39;re going to need <code>dmraid</code> to allow Linux to see your RAID0
drives/partitions for what they are.  On Gentoo:</p>
<pre><code class="hljs bash">$ <span class="hljs-built_in">sudo</span> emerge dmraid</code></pre>

<p>A full explanation of dmraid is outside the scope of this post, and an exercise
I leave to the reader.  In a nutshell, it creates device nodes in <code>/dev/mapper</code>
that reverence your RAID drives/partitions.  On my system:</p>
<pre><code class="hljs bash">$ <span class="hljs-built_in">sudo</span> dmraid -ay
$ ls /dev/mapper
control  isw_bbgfjaijea_Volume0  isw_bbgfjaijea_Volume01  isw_bbgfjaijea_Volume02</code></pre>

<p><code>isw_bbgfjaijea_Volume0</code> is the entire RAID array and
<code>isw_bbgfjaijea_Volume01/isw_bbgfjaijea_Volume02</code> are my Windows partitions.</p>
<h4 id="copy-grub-s-mbr-to-windows-mbr-dominate-">Copy GRUB&#39;s MBR to Windows MBR + DOMINATE!</h4>
<p>Rather than go to all the trouble of setting up GRUB&#39;s device mappings to get
the setup process to run, I took a shortcut.  I installed GRUB to the boot
partition on my Linux install (/dev/sdc1 in this case), and used <code>dd</code> to copy
that to the Windows MBR.</p>
<pre><code class="hljs bash">$ <span class="hljs-built_in">sudo</span> grub
grub&gt; root(hd2,<span class="hljs-number">0</span>)
grub&gt; setup(hd2,<span class="hljs-number">0</span>)
grub&gt; quit
$ <span class="hljs-built_in">sudo</span> dd <span class="hljs-keyword">if</span>=/dev/sdc1 of=/dev/mapper/isw_bbgfjaijea_Volume0 bs=<span class="hljs-number">512</span> count=<span class="hljs-number">1</span>
<span class="hljs-number">1</span>+<span class="hljs-number">0</span> records <span class="hljs-keyword">in</span>
<span class="hljs-number">1</span>+<span class="hljs-number">0</span> records out
<span class="hljs-number">512</span> bytes (<span class="hljs-number">512</span> B) copied, <span class="hljs-number">3.8321</span>e-<span class="hljs-number">05</span> s, <span class="hljs-number">13.4</span> MB/s</code></pre>

<p>At this point I shut down the machine, switched the BIOS to boot from the RAID
array as the primary boot device, and crossed my fingers.</p>
<p>Of course it didn&#39;t work!  I forgot to adjust the <code>grub.conf</code> to account for
the Linux drive being moved to the third physical slot (hd2 vs hd0) after I
plugged the Windows drives back in.  While I was fixing that, I also changed
the <code>fstab</code> file accordingly.  One more reboot, and SHAZAM!  It works.  It&#39;s
worth noting that my first attempt at doing to GRUB install/switcheroo
failed.  I installed it to the MBR of the entire drive (sdc), and after doing
the <code>dd</code> dance, the entire system refused to boot.  I&#39;m not sure why, and
somebody is probably going to berate me for not knowing.  It works now,
so I&#39;m finished.</p>

      </article>
      <article class="post">
        <header>
          <h2 class="post-title"><a href="/blog/moving-from-virtualbox-to-physical-disk">Moving from Virtualbox to Physical Disk</a></h2>
          <time datetime="2010-08-21 15:50" class="timestamp">August 21, 2010</time>
        </header><p>I decided to convert one of my Gentoo VirtualBox installs to physical disk
(ie. convert Virtual -&gt; Physical ).  This sounded pretty straightforward,
but after a bit of Googling, all I had found were a bunch of articlesi
explaining how to take a physical partition and convert it to a .vdi.  This
was exactly the opposite of what I wanted to do.</p>
<p>Finally, I found <a href="http://wiki.przemoc.net/tips/linux">this</a>
wiki article, and it all came together.</p>
<h3 id="preparing-the-disks">Preparing the disks</h3>
<p>I had a spare SATA drive laying around, so I powered off the machine and popped
it in.  Using my trusty Gentoo install CD, I partitioned the Linux disk.  My
Virtualbox install had a disk layout like this:</p>
<pre><code>/dev/sda1   /boot
/dev/sda2   &lt;swap&gt;
/dev/sda3   /
/dev/sda4   &lt;Extended&gt;
/dev/sda5   /usr
/dev/sda6   /var
</code></pre><p>I basically mirrored that on the Linux drive.  It&#39;s not necessary to be exact,
but make sure each partition has AT LEAST enough space to hold the data you&#39;ll
be moving to it.  I also created one extra partition to hold the .vdi images
temporarily while I got the Linux data extracted.  I would be sure and create
this partition LAST, and at the end of the drive, because once you delete,
renumbering Linux partitions is a pain in the ass.</p>
<h3 id="copying-the-vdi-files">Copying the .vdi files</h3>
<p>Since my windows install is full of games, and reinstalling would be a bitch,
I wanted to get Gentoo copied over and working with my 2 Windows drives
detached from the system to prevent me from accidentally overwriting, say, the
partition table on one of them.</p>
<p>What I did is use the <a href="http://www.fs-driver.org/">IFS driver</a> to mount the
extra partition I created above inside Windows, and copied my 2 Virtualbox
.vdi&#39;s to it (Gentoo.vdi and Gentoo2.vdi).  At this point, I shut down the
machine and disconnected the 2 SATA cables from my Windows drives.  Better safe
than sorry.</p>
<h3 id="copying-the-gentoo-system">Copying the Gentoo system</h3>
<p>Again, I booted the box with the Gentoo install CD in the drive.  It
recognized its HDD as <code>sda</code> (as expected).  Now it was time to start copying
files.  To make things easier, inside the Gentoo LiveCD environment, I made two
directories, <code>/mnt/old</code> and <code>/mnt/new</code>.  The names should be pretty self
explanatory.  Based on the wiki article above, I wrote a little shell script to
make mounting the .vdi partitions easier.  I&#39;ll include the script at the
end of the post.  For instance, to get the /boot partition mounted from the
.vdi image and copied to the new Linux drive:</p>
<pre><code class="hljs bash">saturn-gentoo ~ <span class="hljs-comment"># ./vdi.sh -v /mnt/cdrom/Virtual\ Disks/Gentoo.vdi </span>
PART          OFFSET ID
<span class="hljs-number">1</span>              <span class="hljs-number">65536</span> <span class="hljs-number">83</span>
<span class="hljs-number">2</span>           <span class="hljs-number">34095616</span> <span class="hljs-number">82</span>
<span class="hljs-number">3</span>          <span class="hljs-number">571351552</span> <span class="hljs-number">83</span>
Which partition to you want to mount? (Enter to skip)&gt; <span class="hljs-number">1</span>
Offset: <span class="hljs-number">65536</span>
Enter a mountpoint &gt; /mnt/old
Filesystem <span class="hljs-built_in">type</span> (ex. ext3) &gt; ext2
Mount command:
   mount <span class="hljs-string">"/mnt/cdrom/Virtual Disks/Gentoo.vdi"</span> <span class="hljs-string">"/mnt/old"</span> -t ext2 \
      -o loop,offset=<span class="hljs-number">65536</span>
Execute now? (Yn) &gt; Y
Mount successful
saturn-gentoo ~ <span class="hljs-comment"># mount /dev/sda1 /mnt/new</span>
saturn-gentoo ~ <span class="hljs-comment"># cp -axr /mnt/old/* /mnt/new</span>
saturn-gentoo ~ <span class="hljs-comment"># umount /mnt/old</span>
saturn-gentoo ~ <span class="hljs-comment"># umount /mnt/new</span></code></pre>

<p>Rinse and repeat for the remainder of the partitions.</p>
<h3 id="system-configuration">System configuration</h3>
<p>Since the drive identifier (sda) was the same between VirtualBox and the
physical install, I didn&#39;t have to touch <code>fstab</code> or <code>grub</code>.  I made sure
all partitions were unmounted and rebooted.  With the CD out of the drive, I
was pleasantly surprised to see the Grub prompt, and even more surprised when
everything just booted normally.  I had to do some minimal tweaking to X to
move away from the virtualbox video/input drivers, but other than that, things
Just Worked &reg;.</p>
<h3 id="vdi-script">VDI script</h3>
<p>Here&#39;s the script I used to mount my .vdi partitions.  If anyone finds it
useful, please let me know.</p>
<p><strong>Disclaimer</strong>: This script may wipe out the ozone layer and promote anarchy
among the masses.  Use at your own risk.</p>
<pre><code class="hljs bash"><span class="hljs-shebang">#!/bin/bash</span>
<span class="hljs-comment">#==============================================================================</span>
<span class="hljs-comment"># Copyright 2010 Josh Williams &lt;theprime@codingprime.com&gt;</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Quick and dirty bash script to handle mounting .vdi images from VirtualBox</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># This program is free software: you can redistribute it and/or modify</span>
<span class="hljs-comment"># it under the terms of the GNU General Public License as published by</span>
<span class="hljs-comment"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="hljs-comment"># (at your option) any later version.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># This program is distributed in the hope that it will be useful,</span>
<span class="hljs-comment"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="hljs-comment"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="hljs-comment"># GNU General Public License for more details.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># You should have received a copy of the GNU General Public License</span>
<span class="hljs-comment"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="hljs-comment">#===============================================================================</span>

TEMP_FILENAME=<span class="hljs-string">'/tmp/vdimage'</span>
VDI_FILENAME=<span class="hljs-string">''</span>
DUMP_ONLY=<span class="hljs-number">0</span>

<span class="hljs-comment">#</span>
<span class="hljs-comment"># Print the script usage information</span>
<span class="hljs-comment">#</span>
<span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">usage</span></span>() {
  cat &lt;&lt; EOF
USAGE: <span class="hljs-variable">$0</span> options FILENAME

OPTIONS:
    -h           Show this message
    -p           Print the VDI partition table and exit.
    -t filename  Override the temporary file (default 
                 is ./vdimage)
    -v filename  Path to the .vdi file
EOF
}

<span class="hljs-comment">#</span>
<span class="hljs-comment"># Print the extracted partition table</span>
<span class="hljs-comment">#</span>
<span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">print_partitions</span></span>() {
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"PART          OFFSET ID"</span>
  <span class="hljs-keyword">for</span> part <span class="hljs-keyword">in</span> <span class="hljs-variable">$@</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${part}</span>"</span> | awk -F: <span class="hljs-string">'{printf "%-4s %15s %s\n", $1, $2, $3}'</span>
  <span class="hljs-keyword">done</span>
}

<span class="hljs-comment">#</span>
<span class="hljs-comment"># Get the partition to be mounted</span>
<span class="hljs-comment">#</span>
<span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">select_partition</span></span>() {
  <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
    print_partitions <span class="hljs-variable">${valid_partitions[@]}</span>
    <span class="hljs-built_in">read</span> -p <span class="hljs-string">"Which partition to you want to mount? (Enter to skip)&gt; "</span> part_num
    <span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">${part_num}</span>"</span> ]; <span class="hljs-keyword">then</span>
      <span class="hljs-keyword">for</span> (( i = <span class="hljs-number">0</span> ; i &lt; <span class="hljs-variable">${#valid_partitions[@]}</span> ; i++ )); <span class="hljs-keyword">do</span>
        part=<span class="hljs-variable">${valid_partitions[i]}</span>
        part_id=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${part}</span>"</span> | awk -F: <span class="hljs-string">'{print $1;}'</span>`
        <span class="hljs-keyword">if</span> [ <span class="hljs-variable">${part_id}</span> == <span class="hljs-variable">$part_num</span> ]; <span class="hljs-keyword">then</span>
          num=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${part}</span>"</span> | awk -F: <span class="hljs-string">'{print $1;}'</span>`
          offset=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${part}</span>"</span> | awk -F: <span class="hljs-string">'{print $2;}'</span>`
          typ_id=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${part}</span>"</span> | awk -F: <span class="hljs-string">'{print $3;}'</span>`

          selected_partition=( <span class="hljs-variable">$num</span> <span class="hljs-variable">$offset</span> <span class="hljs-variable">$typ_id</span> )
          <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">fi</span>
      <span class="hljs-keyword">done</span>
    <span class="hljs-keyword">fi</span>

    <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">${selected_partition}</span>"</span> ]; <span class="hljs-keyword">then</span>
      <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">${part_num}</span>"</span> ]; <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Invalid partition number: <span class="hljs-variable">${part_num}</span>"</span>
        <span class="hljs-keyword">continue</span>
      <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">done</span>
}

<span class="hljs-comment">#</span>
<span class="hljs-comment"># Get the mountpoint</span>
<span class="hljs-comment">#</span>
<span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">select_mountpoint</span></span>() {
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"Offset: <span class="hljs-variable">${selected_partition[1]}</span>"</span>
  <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">read</span> -p <span class="hljs-string">"Enter a mountpoint &gt; "</span> mountpoint
    <span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">${mountpoint}</span>"</span> ]; <span class="hljs-keyword">then</span>
      <span class="hljs-keyword">if</span> [ <span class="hljs-operator">-d</span> <span class="hljs-string">"<span class="hljs-variable">${mountpoint}</span>"</span> ]; <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Not a valid directory: <span class="hljs-variable">${mountpoint}</span>"</span>
        <span class="hljs-keyword">continue</span>
      <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">done</span>
}

<span class="hljs-comment">#</span>
<span class="hljs-comment"># Select Filesystem type</span>
<span class="hljs-comment">#</span>
<span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">select_fs_type</span></span>() {
  supported_filesystems=`cat /proc/filesystems | \
    sed <span class="hljs-string">'s/^nodev//'</span> | awk <span class="hljs-string">'{print $1;}'</span>`
  <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
    valid_fs_<span class="hljs-built_in">type</span>=<span class="hljs-number">0</span>
    <span class="hljs-built_in">read</span> -p <span class="hljs-string">"Filesystem type (ex. ext3) &gt; "</span> fs_<span class="hljs-built_in">type</span>
    <span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">$fs_type</span>"</span> ]; <span class="hljs-keyword">then</span>
      <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-variable">${supported_filesystems}</span>; <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$i</span> == <span class="hljs-variable">${fs_type}</span> ]]; <span class="hljs-keyword">then</span>
          valid_fs_<span class="hljs-built_in">type</span>=<span class="hljs-number">1</span>
          <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">fi</span>
      <span class="hljs-keyword">done</span>
      <span class="hljs-keyword">if</span> (( <span class="hljs-variable">$valid_fs_type</span> )); <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Filesystem type not supported: <span class="hljs-variable">${fs_type}</span>"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
        fs_<span class="hljs-built_in">type</span>=<span class="hljs-string">""</span>
      <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">done</span>
}

<span class="hljs-comment">#</span>
<span class="hljs-comment"># Handle the actual mounting</span>
<span class="hljs-comment">#</span>
<span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">handle_mount</span></span>() {
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"Mount command:"</span>
  cmd=<span class="hljs-string">'mount "'</span><span class="hljs-variable">${VDI_FILENAME}</span><span class="hljs-string">'" "'</span><span class="hljs-variable">${mountpoint}</span><span class="hljs-string">'" -t '</span><span class="hljs-variable">${fs_type}</span><span class="hljs-string">' \
    -o loop,offset='</span><span class="hljs-variable">${selected_partition[1]}</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"   <span class="hljs-variable">${cmd}</span>"</span>
  <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">read</span> -p <span class="hljs-string">"Execute now? (Yn) &gt; "</span> answer
    <span class="hljs-keyword">if</span> [ ! -n <span class="hljs-string">"<span class="hljs-variable">${answer}</span>"</span> ]; <span class="hljs-keyword">then</span> answer=<span class="hljs-string">"Y"</span>; <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">case</span> <span class="hljs-variable">$answer</span> <span class="hljs-keyword">in</span>
    [yY])
      mount <span class="hljs-string">"<span class="hljs-variable">${VDI_FILENAME}</span>"</span> <span class="hljs-string">"<span class="hljs-variable">${mountpoint}</span>"</span> -t <span class="hljs-variable">${fs_type}</span> -o \
        loop,offset=<span class="hljs-variable">${selected_partition[1]}</span>
      <span class="hljs-keyword">break</span>
      ;;
    [nN])
      <span class="hljs-keyword">break</span>
      ;;
    *)
      <span class="hljs-built_in">echo</span> <span class="hljs-string">"Invalid response: <span class="hljs-variable">${answer}</span>\n"</span>
      ;;
    <span class="hljs-keyword">esac</span>
  <span class="hljs-keyword">done</span>
}

<span class="hljs-comment">#</span>
<span class="hljs-comment"># Check the arguments</span>
<span class="hljs-comment">#</span>
<span class="hljs-keyword">while</span> <span class="hljs-built_in">getopts</span> <span class="hljs-string">"hv:t:p"</span> OPTION
<span class="hljs-keyword">do</span>
  <span class="hljs-keyword">case</span> <span class="hljs-variable">$OPTION</span> <span class="hljs-keyword">in</span>
    h)
      usage
      <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span>
      ;;
    v)
      VDI_FILENAME=<span class="hljs-variable">$OPTARG</span>
      ;;
    t)
      TEMP_FILENAME=<span class="hljs-variable">$OPTARG</span>
      ;;
    p)
      DUMP_ONLY=<span class="hljs-number">1</span>
      ;;
    ?)
      usage
      <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span>
      ;;
  <span class="hljs-keyword">esac</span>
<span class="hljs-keyword">done</span>

<span class="hljs-comment">#</span>
<span class="hljs-comment"># Make sure the .vdi file actually exists</span>
<span class="hljs-comment">#</span>
<span class="hljs-keyword">if</span> [[ -z <span class="hljs-variable">$VDI_FILENAME</span> ]]; <span class="hljs-keyword">then</span> usage; <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span>; <span class="hljs-keyword">fi</span>

<span class="hljs-comment">#</span>
<span class="hljs-comment"># Make sure we're dealing with a fixed size image</span>
<span class="hljs-comment">#</span>
fixed=`od -j76 -N4 -td4 <span class="hljs-string">"<span class="hljs-variable">${VDI_FILENAME}</span>"</span> | awk <span class="hljs-string">'NR==1{print 2;}'</span>`
<span class="hljs-keyword">if</span> [ <span class="hljs-variable">$fixed</span> != <span class="hljs-string">"2"</span> ]; <span class="hljs-keyword">then</span> <span class="hljs-built_in">echo</span> <span class="hljs-string">"Not a fixed disk."</span>; <span class="hljs-keyword">exit</span>; <span class="hljs-keyword">fi</span>

<span class="hljs-comment">#</span>
<span class="hljs-comment"># Find the initial offset</span>
<span class="hljs-comment">#</span>
initial_offset=`od -j344 -N4 -td4 <span class="hljs-string">"<span class="hljs-variable">${VDI_FILENAME}</span>"</span> | awk <span class="hljs-string">'NR==1{print $2;}'</span>`

<span class="hljs-comment">#</span>
<span class="hljs-comment"># Extract the partition table</span>
<span class="hljs-comment">#</span>
dd <span class="hljs-keyword">if</span>=<span class="hljs-string">"<span class="hljs-variable">${VDI_FILENAME}</span>"</span> of=<span class="hljs-variable">${TEMP_FILENAME}</span> bs=<span class="hljs-number">1</span> skip=<span class="hljs-variable">${initial_offset}</span> \
  count=<span class="hljs-number">512</span> &gt;&gt; /dev/null <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span>
parts=`sfdisk -luS <span class="hljs-variable">${TEMP_FILENAME}</span> <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span> | grep -E <span class="hljs-string">"^ ?<span class="hljs-variable">${TEMP_FILENAME}</span>"</span> | \
  sed -E <span class="hljs-string">"s|<span class="hljs-variable">${TEMP_FILENAME}</span>||"</span> | sed <span class="hljs-string">'s/*//'</span> | \
  awk <span class="hljs-string">'{gsub(/ */,"",$1); print $1 ":" $2 ":" $5;}'</span>`

<span class="hljs-comment">#</span>
<span class="hljs-comment"># Cleanup the Temp file</span>
<span class="hljs-comment">#</span>
<span class="hljs-keyword">if</span> [ <span class="hljs-operator">-e</span> <span class="hljs-variable">${TEMP_FILENAME}</span> ]; <span class="hljs-keyword">then</span>
  rm <span class="hljs-variable">${TEMP_FILENAME}</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment">#</span>
<span class="hljs-comment"># Gather the partitions that are valid for mounting</span>
<span class="hljs-comment"># This basically drops anything that is an Extended partition ( Type 5 )</span>
<span class="hljs-comment">#</span>
valid_partitions=( )
<span class="hljs-keyword">for</span> part <span class="hljs-keyword">in</span> <span class="hljs-variable">$parts</span>; <span class="hljs-keyword">do</span>
  typ_id=`<span class="hljs-built_in">echo</span> <span class="hljs-variable">$part</span> | awk -F: <span class="hljs-string">'{print $3;}'</span>`
  <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">${typ_id}</span>"</span> != <span class="hljs-string">"5"</span> ]; <span class="hljs-keyword">then</span>
    num=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${part}</span>"</span> | awk -F: <span class="hljs-string">'{print $1;}'</span>`
    offset=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${part}</span>"</span> | awk -F: <span class="hljs-string">'{print $2;}'</span>`
    offset=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${offset}</span> * 512 + <span class="hljs-variable">$initial_offset</span>"</span> | bc`
    valid_partitions=( <span class="hljs-string">"<span class="hljs-variable">${valid_partitions[@]}</span>"</span> <span class="hljs-string">"<span class="hljs-variable">${num}</span>:<span class="hljs-variable">${offset}</span>:<span class="hljs-variable">${typ_id}</span>"</span> )
  <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span>


<span class="hljs-keyword">if</span> (( <span class="hljs-variable">$DUMP_ONLY</span> )); <span class="hljs-keyword">then</span>
  print_partitions <span class="hljs-variable">${valid_partitions[@]}</span>
<span class="hljs-keyword">else</span>
  <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
    selected_partition=<span class="hljs-string">""</span>
    mountpoint=<span class="hljs-string">""</span>
    fs_<span class="hljs-built_in">type</span>=<span class="hljs-string">""</span>

    select_partition

    <span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">${selected_partition}</span>"</span> ]; <span class="hljs-keyword">then</span>
      select_mountpoint
    <span class="hljs-keyword">fi</span>

    <span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">${mountpoint}</span>"</span> ]; <span class="hljs-keyword">then</span>
      select_fs_<span class="hljs-built_in">type</span>
    <span class="hljs-keyword">fi</span>

    <span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">${fs_type}</span>"</span> ]; <span class="hljs-keyword">then</span>
      handle_mount
    <span class="hljs-keyword">fi</span>

    <span class="hljs-keyword">if</span> [ ! -n <span class="hljs-string">"<span class="hljs-variable">$fs_type</span>"</span> ]; <span class="hljs-keyword">then</span> <span class="hljs-keyword">break</span>; <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">done</span>
<span class="hljs-keyword">fi</span></code></pre>

<p>Is it overkill? Yes. But I did it anyway. Next time: getting Windows back into
the mix.</p>

      </article>
      <article class="post">
        <header>
          <h2 class="post-title"><a href="/blog/first-post">First Post</a></h2>
          <time datetime="2010-02-18 00:45" class="timestamp">February 18, 2010</time>
        </header><p>Yep.  It&#39;s live.</p>
<pre><code><span class="hljs-attribute">josh</span><span class="hljs-variable">@komos</span>: pts/<span class="hljs-number">0</span> -&gt; uptime
 <span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">31</span> up <span class="hljs-number">20</span> days,  <span class="hljs-number">7</span>:<span class="hljs-number">44</span>,  <span class="hljs-number">2</span> users,  load <span class="hljs-attribute">average</span>: <span class="hljs-number">0.20</span>, <span class="hljs-number">0.06</span>, <span class="hljs-number">0.02</span></code></pre>
      </article>
    </div>
    <footer class="site-footer">
      <div class="container">
        <h2 class="footer-heading">CodingPrime</h2>
        <div class="footer-col-wrapper">
          <div class="footer-col footer-col-1">
            <ul class="contact-list">
              <li>CodingPrime</li>
              <li><a href="#">site.email_address</a></li>
            </ul>
          </div>
          <div class="footer-col footer-col-2">
            <ul class="social-media-list">
              <li><a href="https://github.com/t3hpr1m3"><span class="icon icon--github">
                    <svg viewBox="0 0 16 16">
                      <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"></path>
                    </svg></span><span class="username">t3hpr1m3</span></a></li>
              <li><a href="https://twitter.com/t3hpr1m3"><span class="icon icon--twitter">
                    <svg viewBox="0 0 16 16">
                      <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809 c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"></path>
                    </svg></span><span class="username">t3hpr1m3</span></a></li>
            </ul>
          </div>
          <div class="footer-col footer-col-3">
            <p class="text">Write an awesome description for your new site here. You     can edit this line in _config.yml. It will appear in your document     head meta (for Google search results) and in your feed.xml site   description.</p>
          </div>
        </div>
      </div>
    </footer>
  </body>
</html>