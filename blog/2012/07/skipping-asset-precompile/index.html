<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CodingPrime</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Inconsolata%7COswald%7COxygen%7CSource+Code+Pro">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/highlight.js.solarized.css">
  </head>
  <body>
    <header>
      <section class="container">
        <h1><a href="/">CodingPrime</a></h1><span>&lt;strong&gt;kung fu&lt;/strong&gt;</span><a href="https://github.com/t3hpr1m3/codingprime.com"><img style="position: absolute; top: 0; right: 0; border: 0" src="https://camo.githubusercontent.com/652c5b9acfaddf3a9c326fa6bde407b87f7be0f4/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>
      </section>
    </header>
    <main class="container">
      <article class="post">
        <header>
          <time datetime="2012-07-12 17:20">July 12, 2012</time>
          <h2>Skipping asset precompile
          </h2>
        </header>
        <section><p>Waiting on asset precompilation is a PITA, especially if no assets have been
changed.  Thankfully,
<a href="http://www.bencurtis.com/2011/12/skipping-asset-compilation-with-capistrano/">Ben Curtis</a>
came up with a workable solution.  Except...</p>
<p>Ben&#39;s method fails on the initial deployment, because <em>current_revision</em> tries to
read <em>/path/to/app/current/REVISION</em>, which won&#39;t exist yet.  After trying several
approaches, I have arrived at one which works for me.  There are probably other,
more elegant approaches, but this one seems clear enough for my purposes. 
Posting it here for posterity.</p>
<!--more-->
<pre><code class="hljs ruby">namespace <span class="hljs-symbol">:deploy</span> <span class="hljs-keyword">do</span>
  namespace <span class="hljs-symbol">:assets</span> <span class="hljs-keyword">do</span>
    task <span class="hljs-symbol">:precompile</span>, <span class="hljs-symbol">roles:</span> <span class="hljs-symbol">:web</span>, <span class="hljs-symbol">except:</span> {<span class="hljs-symbol">no_release:</span> <span class="hljs-keyword">true</span>} <span class="hljs-keyword">do</span>
      from = source.next_revision(current_revision) <span class="hljs-keyword">if</span> capture(<span class="hljs-string">"[ -f <span class="hljs-subst">#{<span class="hljs-constant">File</span>.join(current_path, <span class="hljs-string">'REVISION'</span>)}</span> ] || echo '1'"</span>).empty?
      <span class="hljs-keyword">if</span> from.<span class="hljs-keyword">nil</span>? || capture(<span class="hljs-string">"cd <span class="hljs-subst">#{latest_release}</span> &amp;&amp; <span class="hljs-subst">#{source.local.log(from)}</span> vendor/assets app/assets lib/assets | wc -l"</span>).to_i &gt; <span class="hljs-number">0</span>
        run <span class="hljs-string">%Q{cd <span class="hljs-subst">#{latest_release}</span> &amp;&amp; <span class="hljs-subst">#{rake}</span> RAILS_ENV=<span class="hljs-subst">#{rails_env}</span> <span class="hljs-subst">#{asset_env}</span> assets:precompile}</span>
      <span class="hljs-keyword">else</span>
        logger.info <span class="hljs-string">"Skipping asset pre-compilation because there were no asset changes."</span>
      <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></code></pre>
        </section>
      </article>
      <div id="disqus_thread">
        <script type="text/javascript">
          /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
          var disqus_shortname = 'codingprime'; // required: replace example with your forum shortname
          
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
        <noscript>Please enable JavaScript to view the<a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    </main>
    <footer class="site-footer">
      <section class="container clearfix">
        <p class="text"><span>&copy;2015 Josh Williams</span><a href="https://github.com/t3hpr1m3"><i class="fa fa-github fa-3x"></i></a><a href="https://twitter.com/t3hpr1m3"><i class="fa fa-twitter fa-3x"></i></a></p>
      </section>
    </footer>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-18124207-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>