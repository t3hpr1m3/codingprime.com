<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CodingPrime</title>
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Inconsolata%7COswald%7COxygen%7CSource+Code+Pro">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/highlight.js.solarized.css">
  </head>
  <body>
    <header>
      <section class="container">
        <h1><a href="/">CodingPrime</a></h1><span>&lt;strong&gt;kung fu&lt;/strong&gt;</span><a href="https://github.com/t3hpr1m3/codingprime.com"><img style="position: absolute; top: 0; right: 0; border: 0" src="https://camo.githubusercontent.com/652c5b9acfaddf3a9c326fa6bde407b87f7be0f4/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>
      </section>
    </header>
    <main class="container">
      <article class="post">
        <header>
          <time datetime="2010-08-21 18:12">August 21, 2010</time>
          <h2>Dual-booting Raided Windows/Non-Raid Linux
          </h2>
        </header>
        <section><p>If you&#39;re following along at home, I got my Gentoo install
<a href="../moving-from-virtualbox-to-physical-disk">extracted</a> and running on physical
disk.  Now I have a problem to solve: Dual booting with Windows.  This is
only a problem because my Windows install is on a RAID0 array using an Intel
fakeraid controller.  I found all kinds of info on dual-booting Windows/Linux
while both are installed in the raid array, but nothing to help with my
situation.  So here we go.</p>
<h3 id="attempt-1-grub-on-the-linux-drive">Attempt #1 :: GRUB on the Linux drive</h3>
<p>My first attempt was to setup GRUB on the Linux drive, and tell the BIOS to
boot off that.  I knew I should add an entry to <code>grub.conf</code> to reference the
Windows drive and call <code>chainloader+</code>, but as I was typing it out I realized
that I didn&#39;t have a way to reference it.  My Spidey Sense&#0153; was telling
me I&#39;d need an initrd with all the raid info in it, so GRUB would know how to
talk to the entire RAID drive.  That sounds like work.  Moving on.</p>
<!--more-->

<h3 id="attempt-2-grub-loaded-from-windows-boot-ini">Attempt #2 :: GRUB loaded from Windows boot.ini</h3>
<p>Next, I tried <a href="http://www.linux.com/archive/feature/113945">this</a> trick, which
has worked for me in the past.  This basically involves saving GRUB&#39;s MBR into
a file, and loading it up from Windows&#39; boot.ini, so it shows up as a bootable
entry on startup.  So I created a grub.bin from my Linux drive, copied it over,
and added the entry to boot.ini.  After a reboot, I received the dreaded
<code>GRUB Error 21</code> (which, by the way, is the most frustrating error ever
conceived by man).  Strike 2.</p>
<h3 id="attempt-3-grub-on-windows-mbr-success-">Attempt #3 :: GRUB on Windows MBR (Success!)</h3>
<p>Once I thought about what I was trying to do, I realized the solution was to
just install GRUB in the MBR of the Windows RAID0 array.  This was a little
more involved, but much less painful than creating a hacky <code>initrd</code>.  So here
goes.</p>
<h4 id="install-dmraid-and-generate-your-device-mappings">Install dmraid and generate your device mappings</h4>
<p>You&#39;re going to need <code>dmraid</code> to allow Linux to see your RAID0
drives/partitions for what they are.  On Gentoo:</p>
<pre><code class="hljs bash">$ <span class="hljs-built_in">sudo</span> emerge dmraid</code></pre>

<p>A full explanation of dmraid is outside the scope of this post, and an exercise
I leave to the reader.  In a nutshell, it creates device nodes in <code>/dev/mapper</code>
that reverence your RAID drives/partitions.  On my system:</p>
<pre><code class="hljs bash">$ <span class="hljs-built_in">sudo</span> dmraid -ay
$ ls /dev/mapper
control  isw_bbgfjaijea_Volume0  isw_bbgfjaijea_Volume01  isw_bbgfjaijea_Volume02</code></pre>

<p><code>isw_bbgfjaijea_Volume0</code> is the entire RAID array and
<code>isw_bbgfjaijea_Volume01/isw_bbgfjaijea_Volume02</code> are my Windows partitions.</p>
<h4 id="copy-grub-s-mbr-to-windows-mbr-dominate-">Copy GRUB&#39;s MBR to Windows MBR + DOMINATE!</h4>
<p>Rather than go to all the trouble of setting up GRUB&#39;s device mappings to get
the setup process to run, I took a shortcut.  I installed GRUB to the boot
partition on my Linux install (/dev/sdc1 in this case), and used <code>dd</code> to copy
that to the Windows MBR.</p>
<pre><code class="hljs bash">$ <span class="hljs-built_in">sudo</span> grub
grub&gt; root(hd2,<span class="hljs-number">0</span>)
grub&gt; setup(hd2,<span class="hljs-number">0</span>)
grub&gt; quit
$ <span class="hljs-built_in">sudo</span> dd <span class="hljs-keyword">if</span>=/dev/sdc1 of=/dev/mapper/isw_bbgfjaijea_Volume0 bs=<span class="hljs-number">512</span> count=<span class="hljs-number">1</span>
<span class="hljs-number">1</span>+<span class="hljs-number">0</span> records <span class="hljs-keyword">in</span>
<span class="hljs-number">1</span>+<span class="hljs-number">0</span> records out
<span class="hljs-number">512</span> bytes (<span class="hljs-number">512</span> B) copied, <span class="hljs-number">3.8321</span>e-<span class="hljs-number">05</span> s, <span class="hljs-number">13.4</span> MB/s</code></pre>

<p>At this point I shut down the machine, switched the BIOS to boot from the RAID
array as the primary boot device, and crossed my fingers.</p>
<p>Of course it didn&#39;t work!  I forgot to adjust the <code>grub.conf</code> to account for
the Linux drive being moved to the third physical slot (hd2 vs hd0) after I
plugged the Windows drives back in.  While I was fixing that, I also changed
the <code>fstab</code> file accordingly.  One more reboot, and SHAZAM!  It works.  It&#39;s
worth noting that my first attempt at doing to GRUB install/switcheroo
failed.  I installed it to the MBR of the entire drive (sdc), and after doing
the <code>dd</code> dance, the entire system refused to boot.  I&#39;m not sure why, and
somebody is probably going to berate me for not knowing.  It works now,
so I&#39;m finished.</p>

        </section>
      </article>
      <div id="disqus_thread">
        <script type="text/javascript">
          /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
          var disqus_shortname = 'codingprime'; // required: replace example with your forum shortname
          
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
        <noscript>Please enable JavaScript to view the<a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    </main>
    <footer class="site-footer">
      <section class="container clearfix">
        <p class="text"><span>&copy;2014 Josh Williams</span><a href="https://github.com/t3hpr1m3"><i class="fa fa-github fa-3x"></i></a><a href="https://twitter.com/t3hpr1m3"><i class="fa fa-twitter fa-3x"></i></a></p>
      </section>
    </footer>
  </body>
</html>